#!/usr/bin/python
# -*- coding: utf-8 -*-
# Sergio Iván Galindo Díaz 
# Obtener el S.O a partir del tamaño de ventana
# Curso: Pentest

import commands
import sys
import socket
from struct import *

# Forma de ejecución del programa
if len(sys.argv) != 2:
	print("Debes ejecutar ./WinOSFingerPrint.py <ipDestino>")
else:
	#Comunicación entre los sockets
	try:
	    s = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_TCP)
	except socket.error , msg:
	    print 'Socket creado revisar el siguienteCodigo de error -> ' + str(msg[0]) + ' Problema ' + msg[1]
	    sys.exit()

	# Ejecutar comando Ping
	commands.getoutput("ping -c1"+ sys.argv[1])

	# Salida del socket se guarda en un paquete
	packet = s.recvfrom(65565)
	     
    # Arreglo a partir del tráfico obtenido
	packet = packet[0]

    # 20 caracteres nos permiten determinan el window size
	cabecer_ip = packet[0:20]

    # Se desempaqueta y se asgna como una cadena
	iph = unpack('!BBHHHBBH4s4s' , cabecera_ip)
    
    # Obtenemos la versión
	version_ihl = iph[0]
	version = version_ihl >> 4
	# Obtenemos IHL
	ihl = version_ihl & 0xF
    
    # Obtenemos la longitud de la cabecera   IP
	iph_length = ihl * 4

	# Obtenemos la cabecera de TCP (es donde esta el window size)
	cabecera_tcp = packet[iph_length:iph_length+20]
     
    # Desempaquetamos nuevamente
	tcph = unpack('!HHLLBBHHH' , cabecera_tcp)

	# Obtenemos el campo deseado
	windowSize = tcph[6]    
    #Resultados segun el tamaño de ventana
	
	if (windowSize == 8192):
		print("Tu Sistema operativo es -> DC-OSx versión 1.1-95")
	elif (windowSize >= 5000 and windowSize <= 9000):
		print("Tu Sistema operativo es -> Windows versión 9x/NT")
	elif (windowSize == 65535):
		print("Tu Sistema operativo es -> Cisco versión 11.2")		
	elif (windowSize == 17520):
		print("Tu Sistema operativo es -> FreeBSD versión 3.x")	
	elif (windowSize == 32120):
		print("Tu Sistema operativo es -> Linux versión 2.2.x")
	elif (windowSize == 16000):
		print("Tu Sistema operativo es -> OpenBSD versión 2.x")
	elif (windowSize == 16000):
		print("Tu Sistema operativo es -> Solaris versión 8")
	elif (windowSize >= 17000 and windowSize <= 18000):
		print("Tu Sistema operativo es -> Windows versión 2000")	
	else:
		print "No se encontro ningun S.O asosiado"